<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Lab Informatics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .active-menu { background-color: rgba(255,255,255,0.15); border-left: 4px solid #fff; }
        .table-header { background-color: #f3f4f6; color: #374151; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 700; white-space: nowrap; }
        td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dino-mascot {
            font-size: 4rem;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-block;
        }
        .dino-mascot:hover { transform: scale(1.2) rotate(10deg); }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <script>
        const BASE_URL = 'http://localhost/inlet-project/public/index.php?url=';
        const IMAGE_URL = 'http://localhost/inlet-project/public/uploads/';
        
        document.addEventListener("DOMContentLoaded", function() {
            const session = localStorage.getItem('lab_user_session');
            if(session) {
                const user = JSON.parse(session);
                if(user.role === 'admin') {
                    showAdminPanel(user);
                } else {
                    showStudentPanel(user);
                }
            } else {
                document.getElementById('login-view').classList.remove('hidden');
            }
        });
    </script>

    <div id="login-view" class="hidden flex items-center justify-center h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 overflow-hidden relative px-4">
        <div class="absolute top-10 left-10 w-20 h-20 bg-white rounded-full opacity-10 animate-bounce"></div>
        <div class="absolute bottom-20 right-20 w-32 h-32 bg-white rounded-full opacity-10 animate-pulse"></div>

        <div class="glass-card p-8 rounded-2xl shadow-2xl w-full max-w-md text-center transform transition-all hover:shadow-indigo-500/50">
            <div class="relative mb-6">
                <div id="dino-bubble" class="bg-white p-2 rounded shadow mb-2 text-sm font-bold text-gray-600">Halo! Saya Dino, penjaga Lab ini. ü¶ñ</div>
                <div id="dino-icon" class="dino-mascot floating">ü¶ñ</div>
            </div>

            <h1 class="text-2xl font-extrabold text-gray-800 mb-1">LAB PORTAL</h1>
            <p class="text-gray-500 text-xs mb-6 font-medium uppercase tracking-wider">Admin & Student Access</p>
            
            <form onsubmit="handleLogin(event)">
                <div class="mb-4 text-left group">
                    <label class="block text-xs font-bold text-gray-600 mb-1 ml-1">EMAIL KAMPUS</label>
                    <input type="email" id="email" value="admin@lab.com" 
                        class="w-full p-3 rounded-xl border border-gray-200 bg-white/50 focus:bg-white focus:ring-2 focus:ring-indigo-300 outline-none" 
                        placeholder="user@lab.com"
                        onfocus="dinoTalk('Hmm... siapa namamu? ü§î')"
                        onblur="dinoTalk('Oke, lanjut passwordnya! üëá')">
                </div>
                
                <div class="mb-6 text-left group">
                    <label class="block text-xs font-bold text-gray-600 mb-1 ml-1">PASSWORD RAHASIA</label>
                    <input type="password" id="password" value="password123" 
                        class="w-full p-3 rounded-xl border border-gray-200 bg-white/50 focus:bg-white focus:ring-2 focus:ring-pink-300 outline-none" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        onfocus="dinoTalk('Ssstt... jangan kasih tau siapa-siapa! ü§´')"
                        onblur="dinoTalk('Siap masuk? Tekan tombolnya! üöÄ')">
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3 rounded-xl font-bold text-lg shadow-lg hover:scale-105 transition-transform flex items-center justify-center gap-2 group">
                    <span>MASUK</span> <span>‚Üí</span>
                </button>
            </form>

            <p id="loginMsg" class="mt-4 text-sm font-bold text-red-500 hidden"></p>
            
            <div class="mt-6 text-xs text-gray-500">
                Lupa password? 
                <a href="forgot_password.html" class="font-bold text-indigo-600 hover:text-pink-600 hover:underline">Tanya Pak Dino di sini.</a>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden h-screen flex overflow-hidden bg-gray-100">
        
        <div id="admin-overlay" onclick="toggleAdminSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <aside id="admin-sidebar" class="sidebar-transition transform -translate-x-full md:translate-x-0 fixed md:relative z-30 w-64 h-full bg-blue-800 text-white flex flex-col shadow-2xl">
            <div class="p-6 border-b border-blue-700 font-bold text-lg tracking-wide flex items-center justify-between">
                <div class="flex items-center gap-2"><span>üöÄ</span> Lab Portal</div>
                <button onclick="toggleAdminSidebar()" class="md:hidden text-white">‚úï</button>
            </div>
            
            <nav class="flex-1 p-3 space-y-1 overflow-y-auto text-sm scrollbar-hide">
                <button onclick="showSection('home')" id="btn-home" class="menu-item active-menu w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üè† Dashboard</button>
                
                <div class="pt-4 px-4 text-xs font-bold text-blue-300 uppercase tracking-wider">Konten Web</div>
                <button onclick="showSection('news')" id="btn-news" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üì∞ Berita</button>
                <button onclick="showSection('activities')" id="btn-activities" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üìÖ Kegiatan</button>
                <button onclick="showSection('facilities')" id="btn-facilities" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üè¢ Fasilitas</button>
                <button onclick="showSection('research')" id="btn-research" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üìö Penelitian</button>
                <button onclick="showSection('gallery')" id="btn-gallery" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üñºÔ∏è Galeri</button>
                
                <div class="pt-4 px-4 text-xs font-bold text-blue-300 uppercase tracking-wider">Administrasi</div>
                <button onclick="showSection('guestbook')" id="btn-guestbook" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üìñ Buku Tamu</button>
                <button onclick="showSection('attendance')" id="btn-attendance" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üì∏ Absensi</button>
                <button onclick="showSection('loans')" id="btn-loans" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üì¶ Peminjaman</button>

                <div class="pt-4 px-4 text-xs font-bold text-blue-300 uppercase tracking-wider">System</div>
                <button onclick="showSection('profile')" id="btn-profile" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">‚öôÔ∏è Profil Lab</button>
                <button onclick="showSection('settings')" id="btn-settings" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üîí Pengaturan Akun</button>
                <button onclick="showSection('users')" id="btn-users" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-blue-700 transition">üë• Manajemen User</button>
            </nav>
            <div class="p-4 border-t border-blue-700 bg-blue-900/30">
                <button onclick="logout()" class="w-full bg-red-500/80 text-white p-2 rounded text-sm hover:bg-red-600 transition font-semibold">Logout</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50 w-full">
            <header class="bg-white h-16 shadow flex items-center justify-between px-4 md:px-8 z-10 border-b shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleAdminSidebar()" class="md:hidden text-gray-600 text-2xl focus:outline-none">‚ò∞</button>
                    <h2 id="page-title" class="text-lg md:text-xl font-bold text-gray-800 tracking-tight truncate">DASHBOARD</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <div class="text-sm font-bold text-gray-700">Admin Lab</div>
                        <div class="text-xs text-green-600 font-semibold">Online ‚óè</div>
                    </div>
                    <div class="h-9 w-9 md:h-10 md:w-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold border border-blue-200">A</div>
                </div>
            </header>
        
            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
                
                <section id="sec-home">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                            <p class="text-blue-100 text-sm font-bold uppercase">Total Pengunjung</p>
                            <h3 class="text-3xl md:text-4xl font-extrabold mt-2" id="stat-visitors">0</h3>
                            <p class="text-xs mt-2 text-blue-100">All Time Views</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                            <p class="text-gray-500 text-sm font-bold">Total Berita</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="stat-news">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                            <p class="text-gray-500 text-sm font-bold">Kegiatan</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="stat-act">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                            <p class="text-gray-500 text-sm font-bold">Fasilitas</p>
                            <h3 class="text-3xl font-bold text-gray-800" id="stat-fac">0</h3>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded shadow border border-gray-100 lg:col-span-2">
                            <h3 class="font-bold text-gray-700 mb-4">Grafik Kunjungan (Dummy)</h3>
                            <div class="h-40 bg-gray-100 rounded flex items-center justify-center text-gray-400">Area Chart Disini</div>
                        </div>
                        <div class="bg-white p-6 rounded shadow border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4">Pintasan</h3>
                            <div class="space-y-2">
                                <button onclick="showSection('news')" class="w-full text-left p-3 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 font-semibold text-sm">‚úçÔ∏è Tulis Berita</button>
                                <button onclick="showSection('guestbook')" class="w-full text-left p-3 bg-green-50 text-green-700 rounded hover:bg-green-100 font-semibold text-sm">üìñ Cek Buku Tamu</button>
                                <button onclick="showSection('loans')" class="w-full text-left p-3 bg-purple-50 text-purple-700 rounded hover:bg-purple-100 font-semibold text-sm">üì¶ Input Peminjaman</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="sec-news" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                        <p class="text-gray-500 text-sm">Kelola artikel berita dan pengumuman.</p>
                        <button onclick="openNewsForm()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2 shadow font-semibold w-full md:w-auto justify-center"><span>+</span> Tambah Berita</button>
                    </div>
                    
                    <div id="form-news" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600 animate-fade-in">
                        <form onsubmit="saveNews(event)">
                            <input type="hidden" id="newsId">
                            <input type="hidden" id="newsImgOld">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Judul Berita</label>
                                    <input type="text" id="newsTitle" class="w-full border p-2 rounded" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Thumbnail</label>
                                    <input type="file" id="newsImgFile" class="w-full border p-1 rounded bg-gray-50 text-sm" accept="image/*">
                                    <p id="newsImgLabel" class="text-xs text-blue-500 mt-1 italic"></p> 
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Konten</label>
                                <textarea id="newsContent" class="w-full border p-2 rounded h-24" required></textarea>
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" onclick="document.getElementById('form-news').classList.add('hidden')" class="bg-gray-300 px-4 py-2 rounded">Batal</button>
                                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Simpan</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded shadow border border-gray-200 overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="table-header"><tr><th class="p-4 w-24">Cover</th><th class="p-4">Judul</th><th class="p-4 w-48">Tanggal</th><th class="p-4 text-center">Aksi</th></tr></thead>
                            <tbody id="newsList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-users" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-gray-500 text-sm">Kelola akses pengguna.</p>
                        <button onclick="openUserForm()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-semibold">+ Tambah</button>
                    </div>
                    <div id="form-user" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <form onsubmit="saveUser(event)">
                            <input type="hidden" id="userId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <input type="text" id="userName" class="w-full border p-2 rounded" placeholder="Nama" required>
                                <input type="email" id="userEmail" class="w-full border p-2 rounded" placeholder="Email" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <select id="userRole" class="w-full border p-2 rounded bg-gray-50"><option value="mahasiswa">Mahasiswa</option><option value="admin">Admin</option></select>
                                <input type="password" id="userPass" class="w-full border p-2 rounded" placeholder="Password (Isi jika ganti)">
                            </div>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold w-full md:w-auto">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="table-header bg-gray-100"><tr><th class="p-4">Nama</th><th class="p-4">Email</th><th class="p-4">Role</th><th class="p-4 text-center">Aksi</th></tr></thead>
                            <tbody id="usersList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-activities" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="openActivityForm()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-semibold">+ Tambah Kegiatan</button>
                    </div>
                    <div id="form-act" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <form onsubmit="saveActivity(event)">
                            <input type="hidden" id="actId"> 
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="actTitle" class="border p-2 rounded" placeholder="Nama Kegiatan" required>
                                <input type="date" id="actDate" class="border p-2 rounded" required>
                            </div>
                            <input type="text" id="actLoc" class="w-full border p-2 rounded mb-2" placeholder="Lokasi" required>
                            <textarea id="actDesc" class="w-full border p-2 rounded h-20 mb-2" placeholder="Deskripsi..." required></textarea>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="table-header"><tr><th class="p-4">Kegiatan</th><th class="p-4">Tanggal</th><th class="p-4">Lokasi</th><th class="p-4 text-center">Aksi</th></tr></thead>
                            <tbody id="activitiesList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-facilities" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="openFacForm()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-semibold">+ Tambah Fasilitas</button>
                    </div>
                    <div id="form-fac" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <form onsubmit="saveFacility(event)">
                            <input type="hidden" id="facId"> <input type="hidden" id="facImgOld">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="facName" class="w-full border p-2 rounded" placeholder="Nama Alat" required>
                                <select id="facType" class="w-full border p-2 rounded"><option value="barang">Barang</option><option value="ruangan">Ruangan</option></select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="number" id="facCap" class="w-full border p-2 rounded" placeholder="Stok" required>
                                <input type="file" id="facImgFile" class="w-full border p-1 rounded text-sm">
                                <p id="facImgLabel" class="text-xs text-blue-500"></p>
                            </div>
                            <textarea id="facDesc" class="w-full border p-2 rounded h-20 mb-2" placeholder="Deskripsi" required></textarea>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[700px]">
                            <thead class="table-header"><tr><th class="p-4">Foto</th><th class="p-4">Nama</th><th class="p-4">Kategori</th><th class="p-4">Stok</th><th class="p-4">Ket</th><th class="p-4">Aksi</th></tr></thead>
                            <tbody id="facilitiesList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-research" class="hidden">
                    <button onclick="openResForm()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 shadow">+ Tambah Data</button>
                    <div id="form-res" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <form onsubmit="saveResearch(event)">
                            <input type="hidden" id="resId">
                            <input type="text" id="resTitle" class="w-full border p-2 rounded mb-3" placeholder="Judul" required>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <input type="text" id="resResearcher" class="border p-2 rounded" placeholder="Peneliti" required>
                                <input type="date" id="resDate" class="border p-2 rounded" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <select id="resType" class="border p-2 rounded"><option value="penelitian">Penelitian</option><option value="publikasi">Publikasi</option><option value="pengabdian">Pengabdian</option></select>
                                <input type="file" id="resFileUpload" class="border p-1 rounded text-sm" accept=".pdf" onchange="handleDocUpload(this, 'resFilePath')">
                                <input type="hidden" id="resFilePath"> <p id="resFileLabel" class="text-xs text-blue-500"></p>
                            </div>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[700px]"><thead class="table-header"><tr><th class="p-4">Judul</th><th class="p-4">Author</th><th class="p-4">Tgl</th><th class="p-4">Jenis</th><th class="p-4">Aksi</th></tr></thead><tbody id="researchList"></tbody></table>
                    </div>
                </section>

                <section id="sec-gallery" class="hidden">
                    <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-pink-500 flex flex-col md:flex-row items-end gap-4">
                        <div class="w-full">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Gambar</label>
                            <input type="file" id="galleryUpload" class="block w-full text-sm border p-1 rounded">
                        </div>
                        <div class="w-full">
                             <label class="block text-xs font-bold text-gray-500 mb-1">Caption</label>
                             <input type="text" id="galleryTitle" placeholder="Judul..." class="border p-2 rounded w-full">
                        </div>
                        <button onclick="uploadGallery()" class="bg-pink-600 text-white px-6 py-2 rounded font-bold shadow w-full md:w-auto h-10">Upload</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="galleryList"></div>
                </section>

                <section id="sec-guestbook" class="hidden">
                    <button onclick="openGuestForm()" class="bg-green-600 text-white px-4 py-2 rounded mb-4 shadow">+ Catat Tamu</button>
                    <div id="form-guest" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-green-600">
                        <form onsubmit="saveGuest(event)">
                            <input type="hidden" id="guestId"> 
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="guestName" class="border p-2 rounded" placeholder="Nama Tamu" required>
                                <input type="text" id="guestInst" class="border p-2 rounded" placeholder="Instansi" required>
                            </div>
                            <textarea id="guestPurpose" class="w-full border p-2 rounded h-20 mb-2" placeholder="Keperluan" required></textarea>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="table-header bg-green-50 text-green-800"><tr><th class="p-4">Tanggal</th><th class="p-4">Nama</th><th class="p-4">Instansi</th><th class="p-4">Keperluan</th><th class="p-4 text-center">Aksi</th></tr></thead>
                            <tbody id="guestList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-attendance" class="hidden">
                    <button onclick="toggleElement('form-attend')" class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 shadow">üì∏ Simulasi Absen</button>
                    <div id="form-attend" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-indigo-600">
                        <form onsubmit="createAttendance(event)">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
                                <input type="text" id="attName" class="border p-2 rounded" placeholder="Nama" required>
                                <input type="text" id="attNim" class="border p-2 rounded" placeholder="NIM" required>
                                <select id="attType" class="border p-2 rounded"><option value="magang">Magang</option><option value="skripsi">Skripsi</option></select>
                            </div>
                            <input type="file" id="attFile" class="border p-1 rounded w-full mb-2 text-sm">
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Kirim</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="table-header bg-indigo-50 text-indigo-800"><tr><th class="p-4">Foto</th><th class="p-4">Mahasiswa</th><th class="p-4">Tipe</th><th class="p-4">Waktu</th><th class="p-4">Aksi</th></tr></thead>
                            <tbody id="attendanceList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-loans" class="hidden">
                    <button onclick="openLoanForm()" class="bg-purple-600 text-white px-4 py-2 rounded mb-4 shadow">+ Peminjaman</button>
                    <div id="form-loan" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-purple-600">
                        <form onsubmit="saveLoan(event)">
                            <input type="hidden" id="loanId"> 
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="loanName" class="w-full border p-2 rounded" placeholder="Peminjam" required>
                                <div>
                                    <select id="loanFacilityId" class="w-full border p-2 rounded bg-white" onchange="setLoanItemName()" required><option value="">-- Loading... --</option></select>
                                    <input type="hidden" id="loanItemName"> 
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <input type="number" id="loanAmount" class="border p-2 rounded w-full" min="1" value="1" required>
                                <input type="date" id="loanDate" class="border p-2 rounded w-full col-span-2">
                            </div>
                            <select id="loanStatus" class="w-full border p-2 rounded bg-gray-50 mb-4"><option value="pending">‚è≥ Menunggu</option><option value="dipinjam">üì¶ Dipinjam</option><option value="kembali">‚úÖ Kembali</option></select>
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[700px]">
                            <thead class="bg-purple-50 text-purple-900 uppercase text-xs font-bold"><tr><th class="p-4">Peminjam</th><th class="p-4">Barang</th><th class="p-4">Jml</th><th class="p-4">Tenggat</th><th class="p-4">Status</th><th class="p-4">Aksi</th></tr></thead>
                            <tbody id="loansList" class="text-sm divide-y"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-profile" class="hidden">
                    <div class="bg-white p-6 rounded shadow max-w-2xl mx-auto border border-gray-200">
                        <h3 class="text-lg font-bold mb-4 text-gray-700">Edit Profil Laboratorium</h3>
                        <form onsubmit="updateProfile(event)">
                            <div class="mb-4"><label class="block text-sm font-bold text-gray-600">Tentang Kami</label><textarea id="profAbout" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div class="mb-4"><label class="block text-sm font-bold text-gray-600">Visi</label><textarea id="profVision" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div class="mb-4"><label class="block text-sm font-bold text-gray-600">Misi</label><textarea id="profMission" class="w-full p-2 border rounded h-20"></textarea></div>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold w-full">Update Profil</button>
                        </form>
                    </div>
                </section>

                <section id="sec-settings" class="hidden">
    <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-10">
        <div class="text-center border-b pb-6 mb-6">
            <div class="h-20 w-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl border-4 border-blue-50">üõ°Ô∏è</div>
            <h2 class="text-xl font-bold text-gray-800" id="adminNameDisplay">Nama Admin</h2>
            <p class="text-sm text-gray-500 mb-2" id="adminEmailDisplay">admin@email.com</p>
            <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wide">Administrator</span>
        </div>

        <h3 class="font-bold text-gray-700 mb-4 text-center">Ganti Password</h3>

        <form onsubmit="updatePassword(event)">
            <input type="hidden" id="settingUserId"> 
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">Password Baru</label>
                <input type="password" id="newPass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Minimal 6 karakter" required>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">Konfirmasi Password</label>
                <input type="password" id="confirmPass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Ketik ulang password" required>
            </div>

            <button type="submit" class="w-full bg-blue-700 text-white p-3 rounded-lg font-bold hover:bg-blue-800 shadow transition flex items-center justify-center gap-2">
                <span>üîí</span> Simpan Password Baru
            </button>
        </form>
    </div>
</section>

                <section id="sec-upload" class="hidden">
                    <div class="bg-white p-8 rounded border-dashed border-2 border-blue-300 text-center">
                        <h3 class="font-bold text-lg mb-2">Upload Test</h3>
                        <input type="file" id="testUploadFile" onchange="handleUpload(this)">
                        <div id="uploadResult" class="mt-4 hidden bg-green-50 p-4 rounded border border-green-200">
                            Nama File: <b id="resName" class="select-all bg-white px-1 border rounded"></b>
                            <img id="previewImg" class="h-40 mx-auto mt-2 rounded shadow object-cover">
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <div id="student-view" class="hidden h-screen flex overflow-hidden bg-gray-50">
        
        <div id="mhs-overlay" onclick="toggleMhsSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <aside id="mhs-sidebar" class="sidebar-transition transform -translate-x-full md:translate-x-0 fixed md:relative z-30 w-64 h-full bg-indigo-800 text-white flex flex-col shadow-2xl">
            <div class="p-6 border-b border-indigo-700 font-bold text-lg tracking-wide flex justify-between items-center">
                <div class="flex gap-2 items-center"><span>üéì</span> Portal Mhs</div>
                <button onclick="toggleMhsSidebar()" class="md:hidden text-white">‚úï</button>
            </div>
            <nav class="flex-1 p-3 space-y-1 overflow-y-auto text-sm">
                <button onclick="showMhsSection('home')" id="btn-mhs-home" class="menu-item active-menu w-full text-left px-4 py-3 rounded hover:bg-indigo-700 transition">üè† Dashboard</button>
                <div class="pt-4 px-4 text-xs font-bold text-indigo-300 uppercase">Informasi</div>
                <button onclick="showMhsSection('activities')" id="btn-mhs-activities" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üìÖ Kegiatan</button>
                <button onclick="showMhsSection('facilities')" id="btn-mhs-facilities" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üè¢ Fasilitas</button>
                <button onclick="showMhsSection('gallery')" id="btn-mhs-gallery" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üñºÔ∏è Galeri</button>
                
                <div class="pt-4 px-4 text-xs font-bold text-indigo-300 uppercase">Akademik</div>
                <button onclick="showMhsSection('research')" id="btn-mhs-research" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üìö Penelitian</button>
                <button onclick="showMhsSection('guestbook')" id="btn-mhs-guestbook" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üìñ Buku Tamu</button>
                <button onclick="showMhsSection('attendance')" id="btn-mhs-attendance" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üì∏ Absensi</button>
                <button onclick="showMhsSection('loans')" id="btn-mhs-loans" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">üì¶ Peminjaman</button>
                
                <div class="pt-4 px-4 text-xs font-bold text-indigo-300 uppercase">Akun</div>
                <button onclick="showMhsSection('settings')" id="btn-mhs-settings" class="menu-item w-full text-left px-4 py-3 rounded hover:bg-indigo-700">‚öôÔ∏è Setting</button>
            </nav>
            <div class="p-4 border-t border-indigo-700 bg-indigo-900/30">
                <div class="text-xs text-indigo-300 mb-2 truncate" id="mhsNameDisplay">Mahasiswa</div>
                <button onclick="logout()" class="w-full bg-red-500/80 text-white p-2 rounded text-sm font-semibold">Logout</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50 w-full">
            <header class="bg-white h-16 shadow flex items-center justify-between px-4 md:px-8 z-10 border-b shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleMhsSidebar()" class="md:hidden text-gray-600 text-2xl">‚ò∞</button>
                    <h2 id="mhs-page-title" class="text-lg md:text-xl font-bold text-gray-800 truncate">DASHBOARD</h2>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative scroll-smooth">
                <section id="sec-mhs-home">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 md:p-8 text-white mb-8">
                        <h2 class="text-2xl md:text-3xl font-bold mb-2">Selamat Datang!</h2>
                        <p class="opacity-90">Akses menu di samping untuk kegiatan laboratorium Anda.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border border-gray-100 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div>
                            <h3 class="font-bold text-gray-700 text-lg">Absensi Hari Ini</h3>
                            <p class="text-gray-500 text-sm">Catat kehadiran magang/skripsi Anda.</p>
                        </div>
                        <button onclick="showMhsSection('attendance')" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold w-full md:w-auto shadow">üì∏ Isi Absen</button>
                    </div>
                </section>

                <section id="sec-mhs-activities" class="hidden">
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[500px]">
                            <thead class="bg-gray-100 font-bold"><tr><th class="p-4">Kegiatan</th><th class="p-4">Tanggal</th><th class="p-4">Lokasi</th></tr></thead>
                            <tbody id="mhsActivitiesList"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-mhs-facilities" class="hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="mhsFacilitiesList"></div>
                </section>

                <section id="sec-mhs-research" class="hidden">
                    <button onclick="openMhsResForm()" class="bg-indigo-600 text-white px-4 py-2 rounded mb-4 shadow">+ Ajukan</button>
                    <div id="form-mhs-res" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-indigo-600">
                        <form onsubmit="saveResearchMhs(event)">
                            <input type="hidden" id="resMhsId">
                            <input type="text" id="resMhsTitle" class="w-full border p-2 rounded mb-3" placeholder="Judul" required>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <input type="text" id="resMhsResearcher" class="border p-2 rounded" placeholder="Nama Anda" required>
                                <input type="date" id="resMhsDate" class="border p-2 rounded" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <select id="resMhsType" class="border p-2 rounded"><option value="penelitian">Penelitian</option><option value="publikasi">Publikasi</option><option value="pengabdian">Pengabdian</option></select>
                                <input type="file" class="border p-1 rounded text-sm" accept=".pdf" onchange="handleDocUpload(this, 'resMhsFilePath')">
                                <input type="hidden" id="resMhsFilePath"> 
                                <p id="resMhsFileLabel" class="text-xs text-indigo-600"></p>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Kirim</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[700px]"><thead class="bg-indigo-50 font-bold"><tr><th class="p-4">Judul</th><th class="p-4">Author</th><th class="p-4">Tgl</th><th class="p-4">Status</th><th class="p-4">Aksi</th></tr></thead><tbody id="mhsResearchList"></tbody></table>
                    </div>
                </section>

                <section id="sec-mhs-gallery" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="mhsGalleryList"></div>
                </section>

                <section id="sec-mhs-guestbook" class="hidden">
                    <button onclick="toggleElement('form-mhs-guest')" class="bg-green-600 text-white px-4 py-2 rounded mb-4 shadow">+ Catat Tamu</button>
                    <div id="form-mhs-guest" class="hidden bg-white p-6 rounded shadow mb-6 border-l-4 border-green-600">
                        <form onsubmit="saveGuestMhs(event)">
                            <input type="hidden" id="guestMhsId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="guestMhsName" class="border p-2 rounded" placeholder="Nama" required>
                                <input type="text" id="guestMhsInst" class="border p-2 rounded" placeholder="Instansi" required>
                            </div>
                            <textarea id="guestMhsPurpose" class="w-full border p-2 rounded h-20 mb-2" placeholder="Keperluan" required></textarea>
                            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Simpan</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]"><thead class="bg-gray-100"><tr><th class="p-4">Tgl</th><th class="p-4">Nama</th><th class="p-4">Instansi</th><th class="p-4">Keperluan</th><th class="p-4">Aksi</th></tr></thead><tbody id="mhsGuestList"></tbody></table>
                    </div>
                </section>

               <section id="sec-mhs-attendance" class="hidden">
                    <div class="bg-white p-6 rounded shadow mb-6">
                        <h3 class="font-bold text-lg mb-4">Form Absensi <span id="mhsAbsenNameDisplay" class="text-sm font-normal text-gray-500 ml-2"></span></h3>
                        <form id="form-attend-mhs" onsubmit="submitAbsensiMhs(event)">
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Nama</label>
                                <input type="text" id="mhsNameInput" class="w-full border p-2 rounded" placeholder="Nama Lengkap" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="mhsNim" class="w-full border p-2 rounded" placeholder="NIM" required>
                                <select id="mhsType" class="w-full border p-2 rounded"><option value="magang">Magang</option><option value="skripsi">Skripsi</option></select>
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Foto Selfie</label>
                                <input type="file" id="mhsPhoto" class="w-full border p-2 rounded" required>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white w-full py-2 rounded font-bold shadow">Kirim</button>
                        </form>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded shadow overflow-x-auto">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">Riwayat</h3>
                        <table class="w-full text-left text-sm min-w-[400px]">
                            <thead class="bg-gray-100"><tr><th class="p-3">Waktu</th><th class="p-3">Tipe</th><th class="p-3">Foto</th></tr></thead>
                            <tbody id="mhsAttendanceHistory"><tr><td colspan="3" class="p-4 text-center text-gray-400">Memuat data...</td></tr></tbody>
                        </table>
                    </div>
                </section>

               <section id="sec-mhs-loans" class="hidden">
                    <h3 class="font-bold text-xl mb-4 text-gray-700">Peminjaman</h3>
                    <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-purple-600">
                        <form onsubmit="saveLoanMhs(event)">
                            <input type="hidden" id="loanMhsId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="text" id="loanMhsName" class="w-full border p-2 rounded bg-gray-100" readonly>
                                <div>
                                    <select id="loanMhsFacilityId" class="w-full border p-2 rounded bg-white" onchange="setMhsLoanItemName()" required><option value="">-- Loading... --</option></select>
                                    <input type="hidden" id="loanMhsItemName">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                <input type="number" id="loanMhsAmount" class="w-full border p-2 rounded" min="1" value="1" required>
                                <input type="date" id="loanMhsDate" class="w-full border p-2 rounded" required>
                            </div>
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded font-bold w-full md:w-auto">Ajukan</button>
                        </form>
                    </div>
                   <div class="bg-white rounded shadow overflow-x-auto border border-gray-200">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-purple-50 text-purple-900 uppercase text-xs font-bold"><tr><th class="p-4">Barang</th><th class="p-4">Kategori</th><th class="p-4">Jml</th><th class="p-4">Tenggat</th><th class="p-4">Status</th><th class="p-4">Aksi</th></tr></thead>
                            <tbody id="mhsLoansList" class="text-sm"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-mhs-settings" class="hidden">
    <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-10">
        <div class="text-center border-b pb-6 mb-6">
            <div class="h-20 w-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl border-4 border-indigo-50">üéì</div>
            <h2 class="text-xl font-bold text-gray-800" id="mhsSettingName">Nama Mahasiswa</h2>
            <p class="text-sm text-gray-500 mb-2" id="mhsSettingEmail">mahasiswa@email.com</p>
            <span class="bg-indigo-100 text-indigo-800 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wide">Mahasiswa</span>
        </div>

        <h3 class="font-bold text-gray-700 mb-4 text-center">Ganti Password</h3>

        <form onsubmit="updatePasswordMhs(event)">
            <input type="hidden" id="mhsSettingId">
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">Password Baru</label>
                <input type="password" id="mhsNewPass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Minimal 6 karakter" required>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">Ulangi Password</label>
                <input type="password" id="mhsConfirmPass" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Ketik ulang password" required>
            </div>

            <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 shadow transition flex items-center justify-center gap-2">
                <span>üîê</span> Update Password
            </button>
        </form>
    </div>
</section>

            </div>
        </main>
    </div>

    <script>
        function dinoTalk(text, mood = 'normal') {

            const bubble = document.getElementById('dino-bubble');

            const dino = document.getElementById('dino-icon');

            

            bubble.innerText = text;

         

            dino.classList.remove('floating', 'shake', 'animate-bounce');

            

            if(mood === 'happy') {

                dino.innerText = 'üòé';

                dino.classList.add('animate-bounce');

            } else if (mood === 'sad') {

                dino.innerText = 'üò≠';

                dino.classList.add('shake');

            } else if (mood === 'thinking') {

                dino.innerText = 'üßê';

                dino.classList.add('floating');

            } else {

                dino.innerText = 'ü¶ñ';

                dino.classList.add('floating');

            }

        }

        function toggleAdminSidebar() {
        console.log("Tombol Hamburger Ditekan!");
        
        const sidebar = document.getElementById('admin-sidebar');
        const overlay = document.getElementById('admin-overlay');
        
        if (!sidebar || !overlay) {
            alert("Error: Elemen Sidebar/Overlay tidak ditemukan ID-nya!");
            return;
        }

        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    }


        function handleLogin(e) {

            e.preventDefault();

            const email = document.getElementById('email').value;

            const password = document.getElementById('password').value;

            const msg = document.getElementById('loginMsg');



            dinoTalk('Tunggu sebentar ya, lagi ngecek database... üì°', 'thinking');

            msg.classList.add('hidden');



            fetch(`${BASE_URL}/auth/login`, {

                method: 'POST',

                body: JSON.stringify({ email, password }),

                headers: { 'Content-Type': 'application/json' }

            })

            .then(res => res.json())

            .then(data => {

                if(data.status === 'success') {

                    const user = data.data;

                    localStorage.setItem('lab_user_session', JSON.stringify(user));

                    

                    dinoTalk('YEY! Login Berhasil! Masukkin Bos! üéâ', 'happy');

                    

                    setTimeout(() => {

                        if(user.role === 'admin') {

                            showAdminPanel(user);

                        } else {

                            showStudentPanel(user);

                        }

                    }, 1500);

                } else {

                    dinoTalk('Yah... Password salah atau akun ga ada. Coba lagi dong! ü•∫', 'sad');

                    msg.innerText = data.message;

                    msg.classList.remove('hidden');

                }

            })

            .catch(err => {

                dinoTalk('Waduh! Servernya meledak (Error Koneksi) üí•', 'sad');

                alert("Gagal koneksi: " + err);

            });

        }



        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }



        function showSection(secId) {

            const sections = ['home', 'news', 'activities', 'facilities', 'research', 'gallery', 'guestbook', 'attendance', 'loans', 'profile','settings','users'];

            sections.forEach(id => {

                document.getElementById('sec-' + id).classList.add('hidden');

                document.getElementById('btn-' + id).classList.remove('active-menu');

            });

            document.getElementById('sec-' + secId).classList.remove('hidden');

            document.getElementById('btn-' + secId).classList.add('active-menu');

            document.getElementById('page-title').innerText = secId.toUpperCase();


            if(secId === 'settings') {
    const user = JSON.parse(localStorage.getItem('lab_user_session'));
    document.getElementById('settingUserId').value = user.id;
    document.getElementById('adminNameDisplay').innerText = user.name;
    document.getElementById('adminEmailDisplay').innerText = user.email;
    
    document.getElementById('newPass').value = '';
    document.getElementById('confirmPass').value = '';
            }

            if(secId === 'news') loadNews();

            if(secId === 'activities') loadActivities();

            if(secId === 'facilities') loadFacilities();

            if(secId === 'research') loadResearch();

            if(secId === 'gallery') loadGallery();

            if(secId === 'guestbook') loadGuests();

            if(secId === 'attendance') loadAttendance();

            if(secId === 'loans') loadLoans();

            if(secId === 'profile') loadProfile();

            if(secId === 'home') initDashboard();

            if(secId === 'users') loadUsers();

        }



        function initDashboard() {

            fetch(`${BASE_URL}/news`).then(r=>r.json()).then(d => document.getElementById('stat-news').innerText = d.data?.length || 0);

            fetch(`${BASE_URL}/activities`).then(r=>r.json()).then(d => document.getElementById('stat-act').innerText = d.data?.length || 0);

            fetch(`${BASE_URL}/facilities`).then(r=>r.json()).then(d => document.getElementById('stat-fac').innerText = d.data?.length || 0);

            

            fetch(`${BASE_URL}/home/index`).then(r=>r.json()).then(d => {

                document.getElementById('stat-visitors').innerText = d.total_visitors || 0;

            });

        }



        // 1. GUESTBOOK

        function loadGuests() {

    fetch(`${BASE_URL}/guests`).then(r=>r.json()).then(d => {

        const list = document.getElementById('guestList'); list.innerHTML = '';

        if(!d.data || d.data.length === 0) { list.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada tamu.</td></tr>'; return; }

        d.data.forEach(g => {

            list.innerHTML += `

            <tr class="border-b hover:bg-gray-50">

                <td class="p-4 text-sm">${g.visit_date}</td>

                <td class="p-4 font-bold">${g.name}</td>

                <td class="p-4">${g.institution}</td>

                <td class="p-4 text-gray-600">${g.purpose}</td>

                <td class="p-4 text-center">

                    <button onclick="editGuest(${g.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">Edit</button>

                    <button onclick="deleteData('guests', ${g.id})" class="text-red-500 font-bold text-xs hover:underline">Hapus</button>

                </td>

            </tr>`;

        });

    });

}



function saveGuest(e) {

    e.preventDefault();

    const id = document.getElementById('guestId').value;

    const endpoint = id ? 'guests/update' : 'guests/store';

    const data = {

        id: id,

        name: document.getElementById('guestName').value,

        institution: document.getElementById('guestInst').value,

        purpose: document.getElementById('guestPurpose').value

    };

    postData(endpoint, data, 'form-guest', loadGuests);

}



function editGuest(id) {

    fetch(`${BASE_URL}/guests/detail/${id}`).then(r=>r.json()).then(d => {

        if(d.status === 'success') {

            document.getElementById('guestId').value = d.data.id;

            document.getElementById('guestName').value = d.data.name;

            document.getElementById('guestInst').value = d.data.institution;

            document.getElementById('guestPurpose').value = d.data.purpose;

            document.getElementById('form-guest').classList.remove('hidden');

        }

    });

}



function openGuestForm() {

    document.getElementById('form-guest').classList.remove('hidden');

    document.getElementById('guestId').value = '';

    document.getElementById('guestName').value = '';

    document.getElementById('guestInst').value = '';

    document.getElementById('guestPurpose').value = '';

}



        // 2. ATTENDANCE

       function loadAttendance() {

    fetch(`${BASE_URL}absensi`).then(r=>r.json()).then(d => {

        const list = document.getElementById('attendanceList');

        list.innerHTML = '';

        

        if(!d.data || d.data.length === 0) { 

            list.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada absen masuk.</td></tr>'; 

            return; 

        }



        d.data.forEach(a => {

            const assets = 'http://localhost/inlet-project/public/';

            let img = a.photo_path.includes('http') ? a.photo_path : `${assets}uploads/${a.photo_path}`;

            

            let sourceInfo = '';

            if(a.account_name) {

                sourceInfo = `<div class="text-[10px] text-gray-500 bg-gray-100 px-1 rounded inline-block mt-1">

                                üîí Akun: ${a.account_name}

                              </div>`;

            } else {

                sourceInfo = `<div class="text-[10px] text-red-400 mt-1">‚ö†Ô∏è Guest (Tanpa Login)</div>`;

            }



            list.innerHTML += `

            <tr class="border-b hover:bg-gray-50">

                <td class="p-4">

                    <img src="${img}" class="w-10 h-10 rounded-full object-cover border shadow-sm" onerror="this.src='https://placehold.co/50'">

                </td>

                <td class="p-4">

                    <div class="font-bold text-gray-800">${a.student_name}</div> <div class="text-xs text-gray-500">${a.student_id}</div>

                    ${sourceInfo} </td>

                <td class="p-4"><span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold uppercase">${a.type}</span></td>

                <td class="p-4 font-mono text-sm text-gray-600">${a.check_in_time}</td>

                <td class="p-4 text-center">

                    <button onclick="deleteData('absensi', ${a.id})" class="text-red-500 font-bold text-xs hover:text-red-700 border border-red-200 px-2 py-1 rounded">Hapus</button>

                </td>

            </tr>`;

        });

    });

}

        function createAttendance(e) {

            e.preventDefault();

            // 1. Upload Foto Dulu

            const fileInput = document.getElementById('attFile');

            if(fileInput.files.length === 0) { alert("Wajib upload foto selfie!"); return; }



            const formData = new FormData();

            formData.append('file', fileInput.files[0]);



            fetch(`${BASE_URL}/uploads/image`, {method: 'POST', body: formData})

            .then(r=>r.json()).then(d => {

                if(d.status === 'success') {

                    // 2. Kirim Data Absen

                    postData('absensi/checkin', {

                        student_name: document.getElementById('attName').value,

                        student_id: document.getElementById('attNim').value,

                        type: document.getElementById('attType').value,

                        photo_path: d.file_name,

                        location: 'Lab Terpadu'

                    }, 'form-attend', loadAttendance);

                } else { alert("Gagal upload foto: " + d.message); }

            });

        }



        // 3. LOANS

       function loadLoans() {

    fetch(`${BASE_URL}/loans`).then(r => r.json()).then(d => {

        const list = document.getElementById('loansList'); 

        list.innerHTML = '';

        

        if(!d.data || d.data.length === 0) { 

            list.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-400 italic">Belum ada data peminjaman.</td></tr>'; 

            return; 

        }



        d.data.forEach(l => {

            let userBadge = '';

            

            if(l.user_name) { 

                let roleColor = l.user_role === 'admin' ? 'bg-red-100 text-red-600 border-red-200' : 'bg-blue-100 text-blue-600 border-blue-200';

                let roleName = l.user_role === 'admin' ? 'ADMIN' : 'MHS';

                

                userBadge = `<span class="${roleColor} text-[10px] px-1 rounded border ml-2 font-bold">${roleName}</span>`;

            } else {

                userBadge = `<span class="bg-gray-100 text-gray-500 text-[10px] px-1 rounded border border-gray-200 ml-2">MANUAL</span>`;

            }



            let catBadge = l.facility_type === 'ruangan' ? '<span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded">Ruang</span>' : '<span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded">Barang</span>';

            let status = l.status ? l.status.toLowerCase() : 'pending';

            let badge = status === 'pending' ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">‚è≥ Menunggu</span>' : (status === 'dipinjam' ? '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">üì¶ Dipinjam</span>' : '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">‚úÖ Selesai</span>');

            

            let btnAction = '';

            if(status === 'pending') btnAction = `<button onclick="approveLoan(${l.id})" class="bg-green-500 text-white px-2 py-1 rounded text-xs mr-1">‚úî</button><button onclick="deleteData('loans', ${l.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs">‚úñ</button>`;

            else if (status === 'dipinjam') btnAction = `<button onclick="processReturn(${l.id})" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 text-xs mr-1">Kembalikan</button><button onclick="editLoan(${l.id})" class="text-gray-500 hover:text-blue-600 text-xs underline">Edit</button>`;

            else btnAction = `<button onclick="deleteData('loans', ${l.id})" class="text-red-400 hover:text-red-600 text-xs">Hapus History</button>`;



            list.innerHTML += `

            <tr class="hover:bg-gray-50 transition border-b">

                <td class="p-4">

                    <div class="font-bold text-gray-700 text-sm flex items-center">

                        ${l.user_name || l.borrower_name} ${userBadge}

                    </div>

                </td>

                <td class="p-4 text-gray-600 text-sm">${l.item_name}</td>

                <td class="p-4 text-center">${catBadge}</td>

                <td class="p-4 text-center font-bold">${l.amount || 1}</td> 

                <td class="p-4 text-center text-red-500 font-mono text-sm">${l.return_date || '-'}</td>

                <td class="p-4 text-center">${badge}</td>

                <td class="p-4 text-center flex justify-center items-center gap-1">${btnAction}</td>

            </tr>`;

        });

    });

}



function approveLoan(id) {

    if(!confirm("Setujui peminjaman ini?")) return;

    fetch(`${BASE_URL}/loans/approve/${id}`, { method: 'POST' })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') {

            loadLoans();

        } else { alert(d.message); }

    });

}



function saveLoan(e) {

    e.preventDefault();

    const id = document.getElementById('loanId').value;

    const data = {

        id: id,

        borrower_name: document.getElementById('loanName').value,

        facility_id: document.getElementById('loanFacilityId').value, 

        item_name: document.getElementById('loanItemName').value,

        amount: document.getElementById('loanAmount').value, 

        return_date: document.getElementById('loanDate').value,

        status: document.getElementById('loanStatus').value

    };

    postData(id ? 'loans/update' : 'loans/store', data, 'form-loan', loadLoans);

}



function editLoan(id) {

    fetch(`${BASE_URL}/loans/detail/${id}`).then(r => r.json()).then(d => {

        if(d.status === 'success') {

            document.getElementById('loanId').value = d.data.id;

            document.getElementById('loanName').value = d.data.borrower_name;

            document.getElementById('loanItem').value = d.data.item_name;

            document.getElementById('loanDate').value = d.data.return_date;

            document.getElementById('loanStatus').value = d.data.status.toLowerCase(); 

            document.getElementById('loanAmount').value = d.data.amount || 1; 

            document.getElementById('form-loan').classList.remove('hidden');

        }

    });

}



function openLoanForm() {

    document.getElementById('form-loan').classList.remove('hidden');

    document.getElementById('loanId').value = '';

    document.getElementById('loanName').value = ''; 

    document.getElementById('loanDate').value = '';

    document.getElementById('loanStatus').value = 'dipinjam';

    

    loadFacilitiesForLoanDropdownAdmin(); 

}



function processReturn(id) {

    if(!confirm("Barang sudah kembali & dicek kondisinya?")) return;

    fetch(`${BASE_URL}/loans/complete/${id}`, { method: 'POST' })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') loadLoans();

        else alert(d.message);

    });

}



function loadNews() {

    fetch(`${BASE_URL}/news`)

    .then(r => r.json())

    .then(d => {

        const list = document.getElementById('newsList');

        list.innerHTML = '';

        

        if (!d.data || d.data.length === 0) {

            list.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada berita.</td></tr>';

            return;

        }



        d.data.forEach(item => {

            const imgBase = (typeof ASSETS_URL !== 'undefined') ? ASSETS_URL : 'http://localhost/inlet-project/public/';

            

            let thumb = item.thumbnail && item.thumbnail.includes('http') 

                ? item.thumbnail 

                : `${imgBase}uploads/${item.thumbnail || 'default.jpg'}`;



            list.innerHTML += `

            <tr class="hover:bg-gray-50 border-b">

                <td class="p-4">

                    <img src="${thumb}" class="w-16 h-12 object-cover rounded bg-gray-200" 

                         onerror="this.src='https://placehold.co/100?text=No+Img'">

                </td>

                <td class="p-4 font-bold">${item.title}</td>

                <td class="p-4 text-sm">${item.created_at || '-'}</td>

                <td class="p-4 text-center">

                    <button onclick="editNews(${item.id})" class="text-blue-600 font-bold text-sm mr-2 hover:underline">Edit</button>

                    <button onclick="deleteData('news', ${item.id})" class="text-red-500 hover:text-red-700 text-sm font-bold bg-red-50 px-3 py-1 rounded">Hapus</button>

                </td>

            </tr>`;

        });

    })

    .catch(err => console.error("Gagal load news:", err));

}



function saveNews(e) {

    e.preventDefault();

    const id = document.getElementById('newsId').value;

    const endpoint = id ? 'news/update' : 'news/store';

    const data = {

        id: id,

        title: document.getElementById('newsTitle').value,

        content: document.getElementById('newsContent').value,

        thumbnail: document.getElementById('newsImg').value

    };

    postData(endpoint, data, 'form-news', loadNews);

}



function editNews(id) {

    fetch(`${BASE_URL}news/detail/${id}`).then(r=>r.json()).then(d => {

        if(d.status === 'success') {

            document.getElementById('newsId').value = d.data.id;

            document.getElementById('newsTitle').value = d.data.title;

            document.getElementById('newsContent').value = d.data.content;

            document.getElementById('newsImgOld').value = d.data.thumbnail; 

            

            document.getElementById('newsImgLabel').innerText = "File saat ini: " + d.data.thumbnail;

            document.getElementById('newsImgFile').value = ""; 

            document.getElementById('form-news').classList.remove('hidden');

        }

    });

}



function openNewsForm() {

    document.getElementById('form-news').classList.remove('hidden');

    document.getElementById('newsId').value = '';

    document.getElementById('newsTitle').value = '';

    document.getElementById('newsContent').value = '';

    document.getElementById('newsImgOld').value = '';

    document.getElementById('newsImgFile').value = '';

    document.getElementById('newsImgLabel').innerText = '';

}



function loadActivities() {

    fetch(`${BASE_URL}/activities`).then(r => r.json()).then(d => {

        const list = document.getElementById('activitiesList'); 

        list.innerHTML = '';

        

        if(!d.data || d.data.length === 0) {

            list.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-400">Belum ada kegiatan.</td></tr>';

            return;

        }



        d.data.forEach(a => {

            list.innerHTML += `

            <tr class="border-b hover:bg-gray-50">

                <td class="p-4 font-bold">${a.title}</td>

                <td class="p-4 text-sm">${a.date_start}</td>

                <td class="p-4 text-sm text-gray-600">${a.location}</td>

                <td class="p-4 text-center">

                    <button onclick="editActivity(${a.id})" class="text-blue-600 font-bold text-sm mr-2 hover:underline">Edit</button>

                    <button onclick="deleteData('activities', ${a.id})" class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded text-sm">Hapus</button>

                </td>

            </tr>`;

        });

    });

}



// Fungsi Baru: Menangani Create DAN Update sekaligus

function saveActivity(e) {

    e.preventDefault();

    

    const id = document.getElementById('actId').value;

    const endpoint = id ? 'activities/update' : 'activities/store'; 

    

    const data = {

        id: id, 

        title: document.getElementById('actTitle').value,

        date_start: document.getElementById('actDate').value,

        location: document.getElementById('actLoc').value,

        description: document.getElementById('actDesc').value

    };



    postData(endpoint, data, 'form-act', loadActivities);

}



function editActivity(id) {

    fetch(`${BASE_URL}/activities/detail/${id}`)

        .then(r => r.json())

        .then(d => {

            if(d.status === 'success') {

                const data = d.data;



                document.getElementById('actId').value = data.id;

                document.getElementById('actTitle').value = data.title;

                document.getElementById('actDate').value = data.date_start;

                document.getElementById('actLoc').value = data.location;

                document.getElementById('actDesc').value = data.description;

                

                document.getElementById('form-act').classList.remove('hidden');

            } else {

                alert(d.message);

            }

        });

}



function openActivityForm() {

    document.getElementById('form-act').classList.remove('hidden');

    document.getElementById('actId').value = ''; 

    document.getElementById('actTitle').value = '';

    document.getElementById('actDate').value = '';

    document.getElementById('actLoc').value = '';

    document.getElementById('actDesc').value = '';

}



function loadFacilities() {

    fetch(`${BASE_URL}/facilities`)

    .then(r => r.json())

    .then(d => {

        const list = document.getElementById('facilitiesList'); 

        list.innerHTML = '';

        

        if (!d.data || d.data.length === 0) {

            list.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-400 italic border-dashed border-2 border-gray-200 rounded m-4">Belum ada fasilitas. Silakan tambah data.</td></tr>';

            return;

        }



        d.data.forEach(f => {



            const baseUrlImg = (typeof ASSETS_URL !== 'undefined') ? ASSETS_URL : 'http://localhost/inlet-project/public/';

            let imgUrl = f.image && f.image.includes('http') 

                ? f.image 

                : `${baseUrlImg}uploads/${f.image || 'default_facility.jpg'}`;

            

            let badge = f.type === 'ruangan' 

                ? '<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded border border-purple-200 font-bold">üè¢ Ruangan</span>'

                : '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded border border-blue-200 font-bold">üì¶ Barang</span>';



            list.innerHTML += `

            <tr class="hover:bg-gray-50 border-b transition">

                <td class="p-4">

                    <img src="${imgUrl}" class="w-16 h-12 object-cover rounded border bg-gray-100 shadow-sm" 

                         onerror="this.src='https://placehold.co/100?text=No+Img'">

                </td>

                <td class="p-4 font-bold text-gray-700">${f.name}</td>

                <td class="p-4">${badge}</td>

                <td class="p-4 font-mono text-sm">${f.capacity}</td>

                <td class="p-4 text-sm text-gray-500 max-w-xs truncate">${f.description || '-'}</td>

                <td class="p-4 text-center">

                    <button onclick="editFacility(${f.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline border border-blue-200 px-2 py-1 rounded">Edit</button>

                    <button onclick="deleteData('facilities', ${f.id})" class="text-red-500 font-bold text-xs hover:underline border border-red-200 px-2 py-1 rounded">Hapus</button>

                </td>

            </tr>`;

        });

    })

    .catch(err => {

        console.error(err);

        document.getElementById('facilitiesList').innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat data: ${err}</td></tr>`;

    });

}



function saveFacility(e) {

    e.preventDefault();

    const id = document.getElementById('facId').value;

    const endpoint = id ? 'facilities/update' : 'facilities/store';

    const data = {

        id: id,

        name: document.getElementById('facName').value,

        type: document.getElementById('facType').value, 

        capacity: document.getElementById('facCap').value,

        description: document.getElementById('facDesc').value,

        image: document.getElementById('facImg').value

    };

    postData(endpoint, data, 'form-fac', loadFacilities);

}



function editFacility(id) {

    fetch(`${BASE_URL}/facilities/detail/${id}`).then(r=>r.json()).then(d => {

        if(d.status === 'success') {

            document.getElementById('facId').value = d.data.id;

            document.getElementById('facName').value = d.data.name;

            document.getElementById('facType').value = d.data.type || 'barang';

            document.getElementById('facCap').value = d.data.capacity;

            document.getElementById('facDesc').value = d.data.description;

            

            document.getElementById('facImgOld').value = d.data.image;

            document.getElementById('facImgLabel').innerText = d.data.image ? "File saat ini: " + d.data.image : "";

            document.getElementById('facImgFile').value = "";



            document.getElementById('form-fac').classList.remove('hidden');

        }

    });

}



function loadFacilitiesForLoanDropdown() {
    fetch(`${BASE_URL}/facilities`).then(r => r.json()).then(d => {
        const select = document.getElementById('loanFacilityId');
        select.innerHTML = '<option value="">-- Pilih Fasilitas --</option>';
        
        if(!d.data) return;

        const barang = d.data.filter(f => f.type === 'barang');
        const ruangan = d.data.filter(f => f.type === 'ruangan');

        if(barang.length > 0) {
            let group = document.createElement('optgroup');
            group.label = "üì¶ BARANG / ALAT";
            barang.forEach(b => {
                let stok = (b.sisa_stok !== undefined) ? b.sisa_stok : b.capacity;
                
                let opt = document.createElement('option');
                opt.value = b.id;
                opt.text = `${b.name} (Sisa: ${stok})`;
                
                if(stok <= 0) opt.disabled = true; 
                
                group.appendChild(opt);
            });
            select.appendChild(group);
        }

        if(ruangan.length > 0) {
            let group = document.createElement('optgroup');
            group.label = "üè¢ RUANGAN / LAB";
            ruangan.forEach(r => {
                let stok = (r.sisa_stok !== undefined) ? r.sisa_stok : r.capacity;
                let status = stok > 0 ? '‚úÖ Tersedia' : '‚ùå Dipakai';

                let opt = document.createElement('option');
                opt.value = r.id;
                opt.text = `${r.name} (${status})`;
                
                if(stok <= 0) opt.disabled = true;

                group.appendChild(opt);
            });
            select.appendChild(group);
        }
    });
}



function openLoanForm() {
    document.getElementById('form-loan').classList.remove('hidden');
    document.getElementById('loanId').value = '';
    document.getElementById('loanName').value = ''; 
    document.getElementById('loanDate').value = '';
    document.getElementById('loanStatus').value = 'dipinjam';
    
    loadFacilitiesForLoanDropdown(); 
}



function setLoanItemName() {

    const select = document.getElementById('loanFacilityId');

    const text = select.options[select.selectedIndex].text;

    document.getElementById('loanItemName').value = text.split(' (')[0];

}

function saveLoan(e) {

    e.preventDefault();

    const id = document.getElementById('loanId').value;

    

    const data = {

        id: id,

        borrower_name: document.getElementById('loanName').value, 

        user_id: null, 

        facility_id: document.getElementById('loanFacilityId').value, 

        item_name: document.getElementById('loanItemName').value,

        amount: document.getElementById('loanAmount').value,

        return_date: document.getElementById('loanDate').value,

        status: document.getElementById('loanStatus').value

    };

    

    postData(id ? 'loans/update' : 'loans/store', data, 'form-loan', loadLoans);

}



function openFacForm() {

    document.getElementById('form-fac').classList.remove('hidden');

    document.getElementById('facId').value = '';

    document.getElementById('facName').value = '';

    document.getElementById('facCap').value = '';

    document.getElementById('facDesc').value = '';

    document.getElementById('facImgOld').value = '';

    document.getElementById('facImgFile').value = '';

    document.getElementById('facImgLabel').innerText = '';

}



function loadResearch() {
    fetch(`${BASE_URL}/researches`).then(r => r.json()).then(d => {
        const list = document.getElementById('researchList');
        list.innerHTML = '';
        
        if (!d.data || d.data.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data penelitian masuk.</td></tr>';
            return;
        }

        d.data.forEach(r => {
            const publicUrl = 'http://localhost/inlet-project/public/';
            let fullPath = r.file_path;
            if (fullPath && !fullPath.includes('uploads/')) { fullPath = 'uploads/' + fullPath; }

            let fileBadge = r.file_path 
                ? `<a href="${publicUrl}${fullPath}" target="_blank" class="text-blue-600 hover:underline text-xs flex items-center gap-1 font-bold">üìÑ Lihat PDF</a>` 
                : `<span class="text-gray-400 text-xs">No File</span>`;

            const statusRaw = r.status ? r.status.toLowerCase() : 'approved'; 
            
            let statusBadge = '';
            let actionBtns = '';

            if (statusRaw === 'pending') {
                statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold border border-yellow-200 animate-pulse">‚è≥ Menunggu ACC</span>`;
                actionBtns = `
                    <div class="flex gap-1 justify-center">
                        <button onclick="approveResearch(${r.id})" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 shadow" title="Terima">‚úî ACC</button>
                        <button onclick="rejectResearch(${r.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 shadow" title="Tolak">‚úñ Tolak</button>
                    </div>
                `;
            } 
            else if (statusRaw === 'rejected') {
                statusBadge = `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold border border-red-200">‚ùå Ditolak</span>`;
                actionBtns = `
                    <button onclick="approveResearch(${r.id})" class="text-green-600 text-xs font-bold hover:underline mr-2">Approve Ulang</button>
                    <button onclick="deleteData('researches', ${r.id})" class="text-red-500 text-xs font-bold hover:underline">Hapus</button>
                `;
            } 
            else {
                statusBadge = `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold border border-green-200">‚úÖ Terbit</span>`;
                actionBtns = `
                    <button onclick="editResearch(${r.id})" class="text-blue-600 font-bold text-xs mr-2 hover:underline">Edit</button>
                    <button onclick="deleteData('researches', ${r.id})" class="text-red-500 font-bold text-xs hover:underline">Hapus</button>
                `;
            }

            list.innerHTML += `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-4">
                    <div class="font-bold text-gray-800">${r.title}</div>
                    <div class="mt-1">${fileBadge}</div>
                </td>
                <td class="p-4 text-sm text-gray-600">${r.researcher}</td>
                <td class="p-4 text-sm font-mono">${r.publication_date || '-'}</td>
                <td class="p-4 text-center">${statusBadge}</td>
                <td class="p-4 text-center">${actionBtns}</td>
            </tr>`;
        });
    });
}



function rejectResearch(id) {

    if(!confirm("Tolak penelitian ini? Mahasiswa akan diminta merevisi.")) return;

    

    fetch(`${BASE_URL}/researches/reject/${id}`, { method: 'POST' })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') {

            loadResearch(); 

        } else { 

            alert(d.message); 

        }

    });

}



function approveResearch(id) {

    if(!confirm("Setujui dan publikasikan penelitian ini?")) return;

    fetch(`${BASE_URL}/researches/approve/${id}`, { method: 'POST' })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') {

            loadResearch();

        } else { alert(d.message); }

    });

}



function saveResearch(e) {

    e.preventDefault();

    const id = document.getElementById('resId').value;

    const data = {

        id: id,

        title: document.getElementById('resTitle').value,

        researcher: document.getElementById('resResearcher').value,

        publication_date: document.getElementById('resDate').value, 

        type: document.getElementById('resType').value,

        file_path: document.getElementById('resFilePath').value, 

        status: 'approved'

    };

    postData(id ? 'researches/update' : 'researches/store', data, 'form-res', loadResearch);

}



function editResearch(id) {

    fetch(`${BASE_URL}/researches/detail/${id}`).then(r=>r.json()).then(d => {

        if(d.status === 'success') {

            document.getElementById('resId').value = d.data.id;

            document.getElementById('resTitle').value = d.data.title;

            document.getElementById('resResearcher').value = d.data.researcher;

            document.getElementById('resDate').value = d.data.publication_date; 

            document.getElementById('resType').value = d.data.type;

            document.getElementById('resFilePath').value = d.data.file_path || '';

            document.getElementById('resFileLabel').innerText = d.data.file_path || '';

            document.getElementById('form-res').classList.remove('hidden');

        }

    });

}



function openResForm() {

    document.getElementById('form-res').classList.remove('hidden');

    document.getElementById('resId').value = '';

    document.getElementById('resTitle').value = '';

    document.getElementById('resResearcher').value = '';

    document.getElementById('resYear').value = '2024';

}



 function loadGallery() {

    fetch(`${BASE_URL}/galleries`).then(r => r.json()).then(d => {

        const list = document.getElementById('galleryList'); 

        list.innerHTML = '';

        

        if (!d.data || d.data.length === 0) { 

            list.innerHTML = '<p class="col-span-4 text-center text-gray-400 border-2 border-dashed p-8 rounded">Belum ada gambar.</p>'; 

            return; 

        }

        

        d.data.forEach(g => {

            const assets = 'http://localhost/inlet-project/public/';

            

            let img = g.image_path.includes('http') ? g.image_path : `${assets}uploads/${g.image_path}`;

            

            list.innerHTML += `

            <div class="relative group aspect-square bg-gray-200 rounded-lg overflow-hidden border shadow-sm hover:shadow-md transition">

                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200?text=No+Image'">

                

                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition p-2">

                    <p class="text-white text-xs mb-2 text-center font-semibold">${g.title || 'Tanpa Judul'}</p>

                    <button onclick="deleteData('galleries', ${g.id})" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600">Hapus</button>

                </div>

            </div>`;

        });

    });

}

        async function uploadGallery() {

    const fileInput = document.getElementById('galleryUpload');

    const title = document.getElementById('galleryTitle').value;

    

    if(fileInput.files.length === 0) return alert('Pilih file dulu!');



    try {

        const filename = await uploadFilePromise(fileInput.files[0]);

        

        const data = {

            title: title,

            image_path: filename,

            category: 'umum'

        };

        

        postData('galleries/store', data, null, () => {

            alert('Berhasil Upload!');

            fileInput.value = '';

            document.getElementById('galleryTitle').value = '';

            loadGallery();

        });

        

    } catch (err) {

        alert("Gagal: " + err.message);

    }

}



        function loadProfile() {

            fetch(`${BASE_URL}/labprofile`).then(r=>r.json()).then(d => {

                if(d.data) { document.getElementById('profAbout').value = d.data.about_us || ''; document.getElementById('profVision').value = d.data.vision || ''; document.getElementById('profMission').value = d.data.mission || ''; }

            });

        }

        function updateProfile(e) { e.preventDefault(); postData('labprofile/update', { about_us: document.getElementById('profAbout').value, vision: document.getElementById('profVision').value, mission: document.getElementById('profMission').value }, null, () => alert('Profil diupdate!')); }



        function handleUpload(input) {

            const formData = new FormData(); formData.append('file', input.files[0]);

            fetch(`${BASE_URL}/uploads/image`, {method: 'POST', body: formData}).then(r=>r.json()).then(d => {

                if(d.status === 'success') {

                    document.getElementById('uploadResult').classList.remove('hidden'); document.getElementById('resName').innerText = d.file_name; document.getElementById('previewImg').src = d.full_url;

                    ['newsImg', 'facImg'].forEach(id => { const el = document.getElementById(id); if(el && !el.closest('.hidden')) el.value = d.file_name; });

                } else { alert(d.message); }

            });

        }



        function postData(endpoint, data, hideFormId, callback) {

    console.log("Sedang mengirim ke: " + endpoint);



    fetch(`${BASE_URL}/${endpoint}`, {

        method: 'POST',

        headers: {'Content-Type': 'application/json'},

        body: JSON.stringify(data)

    })

    .then(response => response.text()) 

    .then(text => {

        try {

            const d = JSON.parse(text);

            if(d.status === 'success') {

                if(hideFormId) document.getElementById(hideFormId).classList.add('hidden');

                alert(d.message || 'Berhasil disimpan!'); 

                if(callback) callback();

            } else {

                alert('Gagal dari Server: ' + d.message);

            }

        } catch (e) {

            console.error("Error Response:", text);

            alert("Terjadi Error Sistem! Cek Console (F12) untuk detail.\n\nPotongan Error:\n" + text.substring(0, 150) + "...");

        }

    })

    .catch(err => {

        alert("Koneksi Gagal / Server Mati: " + err);

    });

}

        function deleteData(endpoint, id) { if(!confirm('Hapus data ini?')) return; fetch(`${BASE_URL}/${endpoint}/delete/${id}`, {method: 'POST'}).then(r=>r.json()).then(d => { if(d.status === 'success') { if(endpoint==='news') loadNews(); if(endpoint==='activities') loadActivities(); if(endpoint==='facilities') loadFacilities(); if(endpoint==='researches') loadResearch(); if(endpoint==='galleries') loadGallery(); } else { alert('Gagal hapus'); } }); }



        function showAdminPanel(user) {

            document.getElementById('login-view').classList.add('hidden');

            document.getElementById('student-view').classList.add('hidden');

            document.getElementById('dashboard-view').classList.remove('hidden');

            initDashboard();

        }

function toggleMhsSidebar() {
        const sidebar = document.getElementById('mhs-sidebar');
        const overlay = document.getElementById('mhs-overlay');
        
        if (sidebar.classList.contains('-translate-x-full')) {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    }

       function submitAbsensiMhs(e) {

    e.preventDefault();

    const fileInput = document.getElementById('mhsPhoto');

    

    if(fileInput.files.length === 0) {

        alert("Wajib upload foto selfie!");

        return;

    }



    const sessionData = localStorage.getItem('lab_user_session');

    if(!sessionData) {

        alert("Sesi habis, silakan login ulang.");

        logout();

        return;

    }

    const user = JSON.parse(sessionData);



    const formData = new FormData();

    formData.append('file', fileInput.files[0]);



    fetch(`${BASE_URL}uploads/image`, {method: 'POST', body: formData})

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') {

            

            const dataAbsen = {

                student_name: document.getElementById('mhsNameInput').value, 

                student_id: document.getElementById('mhsNim').value,

                type: document.getElementById('mhsType').value,

                user_id: user.id, 

                photo_path: d.file_name,

                location: 'Online/Web'

            };

            

            postData('absensi/checkin', dataAbsen, null, () => {

                alert("Absensi Berhasil! Terima kasih, " + user.name);

                

                document.getElementById('form-attend-mhs').classList.add('hidden');

                

                document.getElementById('mhsPhoto').value = '';



                loadMhsAttendanceHistory(); 

            });

        } else { 

            alert("Gagal upload foto: " + d.message); 

        }

    })

    .catch(err => alert("Error Upload: " + err));

}



        function logout() {

            if(confirm('Yakin ingin keluar dari sistem?')) {

                localStorage.removeItem('lab_user_session');

                window.location.reload();

            }

        }

    



    function loadUsers() {

    fetch(`${BASE_URL}/users`).then(r => r.json()).then(d => {

        const list = document.getElementById('usersList');

        list.innerHTML = '';

        if (!d.data) return;



        d.data.forEach(u => {

            let roleBadge = u.role === 'admin' 

                ? `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold">ADMIN</span>`

                : `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">MAHASISWA</span>`;



            list.innerHTML += `

            <tr class="hover:bg-gray-50 border-b">

                <td class="p-4 font-bold">${u.name}</td>

                <td class="p-4 text-sm text-gray-600">${u.email}</td>

                <td class="p-4">${roleBadge}</td>

                <td class="p-4 text-center">

                    <button onclick="editUser(${u.id})" class="text-blue-600 font-bold text-sm mr-2 hover:underline">Edit</button>

                    <button onclick="deleteData('users', ${u.id})" class="text-red-500 font-bold bg-red-50 px-2 py-1 rounded text-sm">Hapus</button>

                </td>

            </tr>`;

        });

    });

}



function saveUser(e) {

    e.preventDefault();

    const id = document.getElementById('userId').value;

    const endpoint = id ? 'users/update' : 'users/store';

    

    const data = {

        id: id,

        name: document.getElementById('userName').value,

        email: document.getElementById('userEmail').value,

        role: document.getElementById('userRole').value,

        password: document.getElementById('userPass').value

    };



    postData(endpoint, data, 'form-user', loadUsers);

}



function editUser(id) {

    fetch(`${BASE_URL}/users/detail/${id}`).then(r => r.json()).then(d => {

        if (d.status === 'success') {

            document.getElementById('userId').value = d.data.id;

            document.getElementById('userName').value = d.data.name;

            document.getElementById('userEmail').value = d.data.email;

            document.getElementById('userRole').value = d.data.role;

            document.getElementById('userPass').value = ''; 

            document.getElementById('form-user').classList.remove('hidden');

        }

    });

}

function updatePassword(e) {
    e.preventDefault();
    
    const p1 = document.getElementById('newPass').value;
    const p2 = document.getElementById('confirmPass').value;

    if(p1.length < 6) return alert("Password minimal 6 karakter!");
    if(p1 !== p2) return alert("Konfirmasi password tidak cocok!");

    if(!confirm('Yakin ingin mengganti password?')) return;

    const data = { 
        user_id: document.getElementById('settingUserId').value, 
        new_password: p1 
    };
    
    postData('settings/change_password', data, null, () => { 
        alert('Password berhasil diganti! Silakan login ulang.'); 
        logout(); 
    });
}



function openUserForm() {

    document.getElementById('form-user').classList.remove('hidden');

    document.getElementById('userId').value = '';

    document.getElementById('userName').value = '';

    document.getElementById('userEmail').value = '';

    document.getElementById('userPass').value = '';

    document.getElementById('userRole').value = 'mahasiswa';

}



function showStudentPanel(user) {

    document.getElementById('login-view').classList.add('hidden');

    document.getElementById('dashboard-view').classList.add('hidden');

    document.getElementById('student-view').classList.remove('hidden');

    

    if(document.getElementById('mhsNameDisplay')) {

        document.getElementById('mhsNameDisplay').innerText = user.name;

    }



    const settingId = document.getElementById('mhsSettingId');

    if(settingId) {

        settingId.value = user.id;

    }

  

    showMhsSection('home');

}



function showMhsSection(secId) {



    const sections = ['home', 'activities', 'facilities', 'research', 'gallery', 'guestbook', 'attendance', 'loans', 'settings'];



    sections.forEach(id => {

        const el = document.getElementById('sec-mhs-' + id);

        if(el) el.classList.add('hidden');

        

        const btn = document.getElementById('btn-mhs-' + id);

        if(btn) btn.classList.remove('active-menu');

    });



    let actualSec = secId;

    if(secId === 'loans-items' || secId === 'loans-rooms') {

        actualSec = 'loans';

    }



    if(secId === 'attendance') {

        const user = JSON.parse(localStorage.getItem('lab_user_session'));

        if(user) {

            document.getElementById('mhsAbsenNameDisplay').innerText = user.name + " (" + user.email + ")";

        }

        loadMhsAttendanceHistory();

    }



    const target = document.getElementById('sec-mhs-' + actualSec);

    if(target) target.classList.remove('hidden');

    

    const btnTarget = document.getElementById('btn-mhs-' + secId);

    if(btnTarget) btnTarget.classList.add('active-menu');



    const titleEl = document.getElementById('mhs-page-title');

    if(titleEl) {

        const titles = {

            'home': 'DASHBOARD',

            'activities': 'KEGIATAN LAB',

            'facilities': 'DAFTAR FASILITAS',

            'research': 'DATA PENELITIAN',

            'gallery': 'GALERI FOTO',

            'guestbook': 'BUKU TAMU',

            'attendance': 'ABSENSI MAHASISWA',

            'loans': 'PEMINJAMAN BARANG/RUANG',

            'settings': 'PENGATURAN AKUN'

        };

        

        titleEl.innerText = titles[actualSec] || actualSec.toUpperCase();

    }

    if(actualSec === 'settings') {
    const user = JSON.parse(localStorage.getItem('lab_user_session'));
    document.getElementById('mhsSettingId').value = user.id;
    document.getElementById('mhsSettingName').innerText = user.name;
    document.getElementById('mhsSettingEmail').innerText = user.email;

    document.getElementById('mhsNewPass').value = '';
    document.getElementById('mhsConfirmPass').value = '';
}

    if(actualSec === 'activities') loadMhsActivities();

    if(actualSec === 'facilities') loadMhsFacilities();

    if(actualSec === 'research') loadMhsResearch();

    if(actualSec === 'gallery') loadMhsGallery();

    if(actualSec === 'guestbook') loadMhsGuestbook();

    if(actualSec === 'loans') {

        const user = JSON.parse(localStorage.getItem('lab_user_session'));

        if(document.getElementById('loanMhsName')) {

             document.getElementById('loanMhsName').value = user ? user.name : ''; 

        }

        loadMhsFacilitiesDropdown(); 

        loadMhsLoans();

    }

}


function loadMhsActivities() {

    fetch(`${BASE_URL}/activities`).then(r=>r.json()).then(d => {

        const list = document.getElementById('mhsActivitiesList'); list.innerHTML = '';

        d.data?.forEach(a => {

            list.innerHTML += `<tr class="border-b"><td class="p-4 font-bold">${a.title}</td><td class="p-4">${a.date_start}</td><td class="p-4 text-gray-600">${a.location}</td></tr>`;

        });

    });

}


function loadMhsFacilities() {

    fetch(`${BASE_URL}/facilities`).then(r=>r.json()).then(d => {

        const list = document.getElementById('mhsFacilitiesList'); list.innerHTML = '';

        d.data?.forEach(f => {

            let img = f.image?.includes('http') ? f.image : `${IMAGE_URL}${f.image || 'default.jpg'}`;

            list.innerHTML += `<div class="bg-white p-4 rounded shadow"><img src="${img}" class="w-full h-40 object-cover rounded mb-2"><h4 class="font-bold">${f.name}</h4><p class="text-sm text-gray-600">${f.description}</p></div>`;

        });

    });

}

function loadMhsResearch() {
    fetch(`${BASE_URL}/researches`).then(r => r.json()).then(d => {
        const list = document.getElementById('mhsResearchList'); 
        list.innerHTML = '';
        
        if (!d.data || d.data.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Belum ada data penelitian.</td></tr>';
            return;
        }

        const currentUser = JSON.parse(localStorage.getItem('lab_user_session'));
        const myId = currentUser ? currentUser.id : null;

        d.data.forEach(r => {
            const isMine = (r.user_id == myId); 

            const statusRaw = r.status ? r.status.toLowerCase() : '';
            const isApproved = (statusRaw === 'approved' || statusRaw === 'terbit');

            if (!isMine && !isApproved) {
                return; 
            }

            const publicUrl = 'http://localhost/inlet-project/public/';
            let fullPath = r.file_path;
            if (fullPath && !fullPath.includes('uploads/')) { fullPath = 'uploads/' + fullPath; }
            
            let fileBadge = r.file_path 
                ? `<a href="${publicUrl}${fullPath}" target="_blank" class="text-indigo-500 hover:underline text-xs flex items-center gap-1 font-bold">üìÑ Lihat PDF</a>` 
                : `<span class="text-gray-400 text-xs">No File</span>`;

            let statusBadge = '';
            let editBtn = '';

            let ownerBadge = isMine ? `<span class="ml-2 bg-indigo-100 text-indigo-700 text-[10px] px-1 rounded border border-indigo-200">Punya Saya</span>` : '';

            if (statusRaw === 'pending' || statusRaw === 'menunggu acc') {
                statusBadge = `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold border border-yellow-200">‚è≥ Menunggu ACC</span>`;
            } else if (statusRaw === 'rejected' || statusRaw === 'ditolak') {
                statusBadge = `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold border border-red-200">‚ùå Ditolak</span>`;
            } else {
                statusBadge = `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold border border-green-200">‚úÖ Terbit</span>`;
            }

            if (isMine) {
                if (isApproved) {
                    editBtn = `<span class="text-gray-400 text-xs italic">üîí Terkunci</span>`;
                } else {
                    editBtn = `<button onclick="editResearchMhs(${r.id})" class="text-indigo-600 font-bold text-xs hover:underline border border-indigo-200 px-2 py-1 rounded bg-white">‚úèÔ∏è Edit</button>`;
                }
            } else {
                editBtn = `<span class="text-gray-300 text-xs">-</span>`;
            }

            list.innerHTML += `
            <tr class="border-b hover:bg-gray-50 transition ${isMine ? 'bg-indigo-50/30' : ''}">
                <td class="p-4">
                    <div class="font-bold text-gray-800 flex items-center">
                        ${r.title}
                        ${ownerBadge}
                    </div>
                    <div class="mt-1">${fileBadge}</div>
                </td>
                <td class="p-4 text-sm text-gray-600">${r.researcher}</td>
                <td class="p-4 text-sm font-mono">${r.publication_date || r.year}</td>
                <td class="p-4">${statusBadge}</td>
                <td class="p-4 text-center">${editBtn}</td>
            </tr>`;
        });
    });
}



function editResearchMhs(id) {

    fetch(`${BASE_URL}/researches/detail/${id}`).then(r => r.json()).then(d => {

        if (d.status === 'success') {

            document.getElementById('resMhsId').value = d.data.id;

            document.getElementById('resMhsTitle').value = d.data.title;

            document.getElementById('resMhsResearcher').value = d.data.researcher;

            document.getElementById('resMhsDate').value = d.data.publication_date; 

            document.getElementById('resMhsType').value = d.data.type;

            

            document.getElementById('resMhsFilePath').value = d.data.file_path || '';

            document.getElementById('resMhsFileLabel').innerText = d.data.file_path 

                ? "File saat ini: " + d.data.file_path 

                : "";



            document.getElementById('form-mhs-res').classList.remove('hidden');

        }

    });

}



function saveResearchMhs(e) {
    e.preventDefault();
    const id = document.getElementById('resMhsId').value;
    
    const currentUser = JSON.parse(localStorage.getItem('lab_user_session'));

    const data = {
        id: id,
        user_id: currentUser.id, 
        title: document.getElementById('resMhsTitle').value,
        researcher: document.getElementById('resMhsResearcher').value,
        publication_date: document.getElementById('resMhsDate').value, 
        type: document.getElementById('resMhsType').value,
        file_path: document.getElementById('resMhsFilePath').value, 
        status: 'pending' 
    };
    
    const endpoint = id ? 'researches/update' : 'researches/store';
    
    postData(endpoint, data, 'form-mhs-res', () => {
        loadMhsResearch();
        alert(id ? "Revisi berhasil dikirim!" : "Data berhasil diajukan!");
    });
}



function openMhsResForm() {

    document.getElementById('form-mhs-res').classList.remove('hidden');

    document.getElementById('resMhsId').value = '';

    document.getElementById('resMhsTitle').value = '';

    document.getElementById('resMhsResearcher').value = '';

    document.getElementById('resMhsDate').value = '';

    document.getElementById('resMhsFilePath').value = '';

    document.getElementById('resMhsFileLabel').innerText = '';

}



function loadMhsGallery() {

    fetch(`${BASE_URL}/galleries`).then(r => r.json()).then(d => {

        const list = document.getElementById('mhsGalleryList'); 

        list.innerHTML = '';

        

        if (!d.data || d.data.length === 0) {

             list.innerHTML = '<p class="col-span-4 text-center text-gray-400 p-4">Belum ada foto di galeri.</p>';

             return;

        }



        d.data.forEach(g => {

            const assets = 'http://localhost/inlet-project/public/';

            let img = g.image_path.includes('http') ? g.image_path : `${assets}uploads/${g.image_path}`;

            

            list.innerHTML += `

            <div class="aspect-square bg-gray-200 rounded-xl overflow-hidden relative group border shadow-sm">

                <img src="${img}" class="w-full h-full object-cover transition transform group-hover:scale-110 duration-500" onerror="this.src='https://placehold.co/200'">

                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent text-white text-xs p-3 pt-6">

                    ${g.title || 'Galeri'}

                </div>

            </div>`;

        });

    });

}



function loadMhsGuestbook() {
    fetch(`${BASE_URL}/guests`).then(r => r.json()).then(d => {
        const list = document.getElementById('mhsGuestList'); 
        list.innerHTML = '';
        
        const currentUser = JSON.parse(localStorage.getItem('lab_user_session'));
        const myId = currentUser ? currentUser.id : null;

        if (!d.data || d.data.length === 0) {
             list.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Belum ada data.</td></tr>';
             return;
        }

        d.data.forEach(g => {
            if (g.user_id != myId) {
                return; 
            }

            list.innerHTML += `
            <tr class="border-b hover:bg-gray-50">
                <td class="p-4 text-sm">${g.visit_date}</td>
                <td class="p-4 font-bold text-gray-700">${g.name}</td>
                <td class="p-4">${g.institution}</td>
                <td class="p-4 text-gray-600">${g.purpose}</td>
                <td class="p-4 text-center">
                    <button onclick="editGuestMhs(${g.id})" class="text-indigo-600 font-bold text-xs hover:underline border border-indigo-200 px-2 py-1 rounded">Edit</button>
                </td>
            </tr>`;
        });
    });
}



function saveGuestMhs(e) {
    e.preventDefault();
    const id = document.getElementById('guestMhsId').value;
    
    const currentUser = JSON.parse(localStorage.getItem('lab_user_session'));

    const data = {
        id: id,
        user_id: currentUser.id, 
        name: document.getElementById('guestMhsName').value,
        institution: document.getElementById('guestMhsInst').value,
        purpose: document.getElementById('guestMhsPurpose').value
    };
    
    const endpoint = id ? 'guests/update' : 'guests/store';
    
    postData(endpoint, data, 'form-mhs-guest', loadMhsGuestbook);
}

function editGuestMhs(id) {

    fetch(`${BASE_URL}/guests/detail/${id}`).then(r=>r.json()).then(d => {

        if(d.status==='success') {

            document.getElementById('guestMhsId').value=d.data.id;

            document.getElementById('guestMhsName').value=d.data.name;

            document.getElementById('guestMhsInst').value=d.data.institution;

            document.getElementById('guestMhsPurpose').value=d.data.purpose;

            document.getElementById('form-mhs-guest').classList.remove('hidden');

        }

    });

}

function loadMhsFacilitiesDropdown() {

    fetch(`${BASE_URL}/facilities`).then(r => r.json()).then(d => {

        const select = document.getElementById('loanMhsFacilityId');

        select.innerHTML = '<option value="">-- Pilih Barang/Ruangan --</option>';

        

        if(!d.data) return;



        const barang = d.data.filter(f => f.type === 'barang');

        const ruangan = d.data.filter(f => f.type === 'ruangan');



        if(barang.length > 0) {

            let group = document.createElement('optgroup');

            group.label = "üì¶ BARANG / ALAT";

            barang.forEach(b => {

                let sisa = parseInt(b.sisa_stok);



                if (sisa <= 0) return; 



                let opt = document.createElement('option');

                opt.value = b.id;

                opt.text = `${b.name} (Sisa: ${sisa})`;

                group.appendChild(opt);

            });

            if(group.children.length > 0) select.appendChild(group);

        }



        if(ruangan.length > 0) {

            let group = document.createElement('optgroup');

            group.label = "üè¢ RUANGAN / LAB";

            ruangan.forEach(r => {

                let sisa = parseInt(r.sisa_stok);



                if (sisa <= 0) return;



                let opt = document.createElement('option');

                opt.value = r.id;

                opt.text = r.name;

                group.appendChild(opt);

            });

            if(group.children.length > 0) select.appendChild(group);

        }

    });

}



function setMhsLoanItemName() {

    const select = document.getElementById('loanMhsFacilityId');

    const text = select.options[select.selectedIndex].text;

    document.getElementById('loanMhsItemName').value = text.split(' (')[0];

}



function loadMhsLoans() {
    fetch(`${BASE_URL}/loans`).then(r => r.json()).then(d => {
        const list = document.getElementById('mhsLoansList'); 
        list.innerHTML = '';

        const myUserId = JSON.parse(localStorage.getItem('lab_user_session')).id;
 
        const myLoans = d.data ? d.data.filter(l => l.user_id == myUserId) : [];

        if(myLoans.length === 0) {
             list.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-400">Belum ada pengajuan.</td></tr>';
             return;
        }

        myLoans.forEach(l => {
            let status = l.status ? l.status.toLowerCase() : 'pending';
            let badge = '';
            let btn = '-'; 

            if (status === 'pending') {
                badge = `<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold border border-yellow-200">‚è≥ Pending</span>`;

                btn = `<button onclick="editLoanMhs(${l.id})" class="text-indigo-600 font-bold text-xs hover:underline border border-indigo-200 px-2 py-1 rounded">Edit</button>`;
            } 
            else if (status === 'dipinjam') {
                badge = `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold border border-blue-200">üì¶ Dipinjam</span>`;

                btn = `<button onclick="returnLoanMhs(${l.id})" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 shadow-sm transition">‚Ü© Kembalikan</button>`;
            } 
            else {
                badge = `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold border border-green-200">‚úÖ Selesai</span>`;
                btn = `<span class="text-gray-300 text-xs italic">Riwayat</span>`;
            }

            let catBadge = l.facility_type === 'ruangan'
                ? '<span class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-1 rounded border border-indigo-200">Ruang</span>'
                : '<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-1 rounded border border-orange-200">Alat</span>';

            list.innerHTML += `
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="p-4 font-bold text-gray-700 text-sm">${l.item_name}</td>
                <td class="p-4 text-center">${catBadge}</td>
                <td class="p-4 text-center font-mono">${l.amount || 1}</td>
                <td class="p-4 font-mono text-xs text-gray-500">${l.return_date}</td>
                <td class="p-4 text-center">${badge}</td>
                <td class="p-4 text-center">${btn}</td>
            </tr>`;
        });
    });
}

function saveLoanMhs(e) {

    e.preventDefault();

    const id = document.getElementById('loanMhsId').value;

    

    const user = JSON.parse(localStorage.getItem('lab_user_session'));



    const data = {

        id: id,

        user_id: user.id, 

        borrower_name: user.name,

        

        facility_id: document.getElementById('loanMhsFacilityId').value, 

        item_name: document.getElementById('loanMhsItemName').value,

        amount: document.getElementById('loanMhsAmount').value,     

        return_date: document.getElementById('loanMhsDate').value,

        status: 'pending'

    };

    

    postData(id ? 'loans/update' : 'loans/store', data, null, () => { 

        alert('Pengajuan Berhasil! Menunggu ACC Admin.'); 

        document.getElementById('loanMhsFacilityId').value = "";

        document.getElementById('loanMhsDate').value = "";

        loadMhsLoans(); 

    });

}



function updatePasswordMhs(e) {
    e.preventDefault();
    
    const p1 = document.getElementById('mhsNewPass').value;
    const p2 = document.getElementById('mhsConfirmPass').value; // Ambil nilai konfirmasi

    if(p1.length < 6) return alert("Password minimal 6 karakter!");
    if(p1 !== p2) return alert("Konfirmasi password tidak cocok! Coba cek lagi.");

    if(!confirm('Ganti Password sekarang?')) return;
    
    const data = { 
        user_id: document.getElementById('mhsSettingId').value, 
        new_password: p1 
    };
    
    postData('settings/change_password', data, null, () => { 
        alert('Password diganti! Silakan login ulang.'); 
        logout(); 
    });
}



function rejectResearch(id) {

    if(!confirm("Tolak penelitian ini? Mahasiswa harus merevisi.")) return;

    fetch(`${BASE_URL}/researches/reject/${id}`, { method: 'POST' })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') loadResearch();

        else alert(d.message);

    });

}



function handleDocUpload(input, targetId) {

    const formData = new FormData();

    formData.append('file', input.files[0]);

    fetch(`${BASE_URL}/uploads/document`, { method: 'POST', body: formData })

    .then(r => r.json())

    .then(d => {

        if(d.status === 'success') {

            document.getElementById(targetId).value = d.file_name;

            input.nextElementSibling.nextElementSibling.innerText = "File siap: " + d.file_name;

        } else {

            alert("Gagal upload: " + d.message);

            input.value = ''; 

        }

    });

}



async function uploadFilePromise(file) {

    const formData = new FormData();

    formData.append('file', file);

    

    try {

        const response = await fetch(`${BASE_URL}uploads/image`, {

            method: 'POST',

            body: formData

        });

        const data = await response.json();

        if(data.status === 'success') {

            return data.file_name;

        } else {

            throw new Error(data.message);

        }

    } catch (error) {

        throw error;

    }

}



async function saveNews(e) {

    e.preventDefault();

    const id = document.getElementById('newsId').value;

    const fileInput = document.getElementById('newsImgFile');

    let filename = document.getElementById('newsImgOld').value; 



    if(fileInput.files.length > 0) {

        try {

            filename = await uploadFilePromise(fileInput.files[0]);

        } catch (err) {

            alert("Gagal Upload Gambar: " + err.message);

            return;

        }

    } else if (!filename) {

        filename = 'default.jpg'; 

    }



    const data = {

        id: id,

        title: document.getElementById('newsTitle').value,

        content: document.getElementById('newsContent').value,

        thumbnail: filename 

    };

    

    postData(id ? 'news/update' : 'news/store', data, 'form-news', loadNews);

}



async function saveFacility(e) {

    e.preventDefault();

    const id = document.getElementById('facId').value;

    const fileInput = document.getElementById('facImgFile');

    let filename = document.getElementById('facImgOld').value;



    if(fileInput.files.length > 0) {

        try {

            filename = await uploadFilePromise(fileInput.files[0]);

        } catch(err) {

            alert("Gagal Upload: " + err.message);

            return;

        }

    } else if(!filename) {

        filename = 'default_facility.jpg';

    }



    const data = {

        id: id,

        name: document.getElementById('facName').value,

        type: document.getElementById('facType').value,

        capacity: document.getElementById('facCap').value,

        description: document.getElementById('facDesc').value,

        image: filename

    };

    

    postData(id ? 'facilities/update' : 'facilities/store', data, 'form-fac', loadFacilities);

}



async function uploadFilePromise(file) {

    const formData = new FormData();

    formData.append('file', file);

    const res = await fetch(`${BASE_URL}uploads/image`, { method: 'POST', body: formData });

    const json = await res.json();

    if(json.status === 'success') return json.file_name;

    throw new Error(json.message);

}



function loadUsersForLoan() {

    fetch(`${BASE_URL}/users`).then(r => r.json()).then(d => {

        const select = document.getElementById('loanUserId');

        select.innerHTML = '<option value="">-- Pilih User --</option>';

        if (!d.data) return;



        d.data.forEach(u => {

            let role = u.role === 'admin' ? '(Admin)' : '(Mhs)';

            let opt = document.createElement('option');

            opt.value = u.id;

            opt.text = `${u.name} ${role}`;

            opt.dataset.name = u.name;

            select.appendChild(opt);

        });

    });

}



function loadMhsAttendanceHistory() {

    fetch(`${BASE_URL}/absensi`).then(r => r.json()).then(d => {

        const list = document.getElementById('mhsAttendanceHistory');

        list.innerHTML = '';



        const myUserId = JSON.parse(localStorage.getItem('lab_user_session')).id;

        const myAbsensi = d.data ? d.data.filter(a => a.user_id == myUserId) : [];



        if(myAbsensi.length === 0) {

            list.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Belum ada riwayat absensi.</td></tr>';

            return;

        }



        myAbsensi.forEach(a => {

            const assets = 'http://localhost/inlet-project/public/';

            let img = a.photo_path.includes('http') ? a.photo_path : `${assets}uploads/${a.photo_path}`;



            list.innerHTML += `

            <tr class="border-b hover:bg-gray-50">

                <td class="p-3 font-mono text-gray-600">${a.check_in_time}</td>

                <td class="p-3"><span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs font-bold uppercase">${a.type}</span></td>

                <td class="p-3">

                    <a href="${img}" target="_blank">

                        <img src="${img}" class="w-8 h-8 rounded-full object-cover border hover:scale-150 transition">

                    </a>

                </td>

            </tr>`;

        });

    });

}

function returnLoanMhs(id) {
    if(!confirm("Apakah Anda yakin sudah mengembalikan barang/ruangan ini?")) return;
    
    fetch(`${BASE_URL}/loans/complete/${id}`, { method: 'POST' })
    .then(r => r.json())
    .then(d => {
        if(d.status === 'success') {
            alert("Terima kasih! Status peminjaman telah diperbarui.");
            loadMhsLoans();             
            loadMhsFacilitiesDropdown(); 
        } else {
            alert("Gagal: " + d.message);
        }
    })
    .catch(err => alert("Error koneksi: " + err));
}
    </script>
</body>
</html>